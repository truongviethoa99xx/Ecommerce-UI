<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Integration Test</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ E-commerce API Integration Test</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ Test Status</h3>
            <div id="status">Ready to test...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” Authentication Test</h3>
            <button onclick="testAuth()">Test Admin Login</button>
            <button onclick="testUserRegister()">Test User Registration</button>
        </div>

        <div class="test-section">
            <h3>ğŸ›ï¸ Products Test</h3>
            <button onclick="testProducts()">Test Get Products</button>
            <button onclick="testCategories()">Test Get Categories</button>
        </div>

        <div class="test-section">
            <h3>ğŸ›’ Cart & Orders Test</h3>
            <button onclick="testCart()">Test Cart Operations</button>
            <button onclick="testOrders()">Test Orders</button>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¨â€ğŸ’¼ Admin Test</h3>
            <button onclick="testAdminStats()">Test Admin Dashboard</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª Full Integration Test</h3>
            <button onclick="runFullTest()">Run All Tests</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Test Log</h3>
            <div id="log" class="log">Click any test button to start...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let adminToken = '';
        let userToken = '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };
            logDiv.innerHTML += `<span style="color: ${colors[type] || colors.info}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = type;
        }

        async function testAuth() {
            try {
                log('ğŸ” Testing admin authentication...', 'info');
                const response = await axios.post(`${API_BASE}/auth/admin/login`, {
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.data.access_token) {
                    adminToken = response.data.access_token;
                    log('âœ… Admin login successful!', 'success');
                    updateStatus('Admin authenticated âœ…', 'success');
                } else {
                    log('âŒ Admin login failed - no token received', 'error');
                }
            } catch (error) {
                log(`âŒ Admin login error: ${error.response?.data?.message || error.message}`, 'error');
                updateStatus('Admin login failed âŒ', 'error');
            }
        }

        async function testUserRegister() {
            try {
                log('ğŸ“ Testing user registration...', 'info');
                const email = `testuser${Date.now()}@example.com`;
                const response = await axios.post(`${API_BASE}/auth/register`, {
                    name: 'Test User',
                    email: email,
                    password: 'password123',
                    phone: '+84987654321',
                    address: '123 Test Street'
                });
                
                if (response.data.access_token) {
                    userToken = response.data.access_token;
                    log(`âœ… User registration successful! Email: ${email}`, 'success');
                } else {
                    log('âŒ User registration failed - no token received', 'error');
                }
            } catch (error) {
                log(`âŒ User registration error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function testProducts() {
            try {
                log('ğŸ›ï¸ Testing products API...', 'info');
                const response = await axios.get(`${API_BASE}/products`);
                log(`âœ… Products API working! Found ${response.data.length || 0} products`, 'success');
            } catch (error) {
                log(`âŒ Products API error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function testCategories() {
            try {
                log('ğŸ·ï¸ Testing categories API...', 'info');
                const response = await axios.get(`${API_BASE}/categories`);
                log(`âœ… Categories API working! Found ${response.data.length || 0} categories`, 'success');
            } catch (error) {
                log(`âŒ Categories API error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function testCart() {
            if (!userToken) {
                log('âš ï¸ Need user token for cart test. Please register first.', 'warning');
                return;
            }

            try {
                log('ğŸ›’ Testing cart API...', 'info');
                const response = await axios.get(`${API_BASE}/cart`, {
                    headers: { Authorization: `Bearer ${userToken}` }
                });
                log(`âœ… Cart API working! Cart has ${response.data.length || 0} items`, 'success');
            } catch (error) {
                log(`âŒ Cart API error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function testOrders() {
            if (!userToken) {
                log('âš ï¸ Need user token for orders test. Please register first.', 'warning');
                return;
            }

            try {
                log('ğŸ“¦ Testing orders API...', 'info');
                const response = await axios.get(`${API_BASE}/orders/my-orders`, {
                    headers: { Authorization: `Bearer ${userToken}` }
                });
                log(`âœ… Orders API working! Found ${response.data.length || 0} orders`, 'success');
            } catch (error) {
                log(`âŒ Orders API error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function testAdminStats() {
            if (!adminToken) {
                log('âš ï¸ Need admin token for stats test. Please login as admin first.', 'warning');
                return;
            }

            try {
                log('ğŸ‘¨â€ğŸ’¼ Testing admin statistics API...', 'info');
                const response = await axios.get(`${API_BASE}/statistics/overview`, {
                    headers: { Authorization: `Bearer ${adminToken}` }
                });
                
                const stats = response.data;
                log(`âœ… Admin stats working!`, 'success');
                log(`   ğŸ“Š Users: ${stats.totalUsers}`, 'info');
                log(`   ğŸ“¦ Products: ${stats.totalProducts}`, 'info');
                log(`   ğŸ›’ Orders: ${stats.totalOrders}`, 'info');
                log(`   ğŸ’° Revenue: $${stats.totalRevenue}`, 'info');
            } catch (error) {
                log(`âŒ Admin stats error: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function runFullTest() {
            log('ğŸš€ Starting full integration test...', 'info');
            updateStatus('Running full test...', 'info');
            
            await testAuth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserRegister();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testProducts();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCategories();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCart();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOrders();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAdminStats();
            
            log('ğŸ‰ Full integration test completed!', 'success');
            updateStatus('All tests completed! âœ…', 'success');
        }

        // Auto-run a quick test on page load
        window.onload = async () => {
            log('ğŸŒŸ API Integration Test Page Loaded', 'info');
            log('Backend API: ' + API_BASE, 'info');
            
            // Quick connectivity test
            try {
                await axios.get(`${API_BASE}`);
                log('âœ… Backend server is running!', 'success');
                updateStatus('Backend server connected âœ…', 'success');
            } catch (error) {
                log('âŒ Cannot connect to backend server', 'error');
                updateStatus('Backend server disconnected âŒ', 'error');
            }
        };
    </script>
</body>
</html>
